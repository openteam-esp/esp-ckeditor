CKEDITOR.plugins.add("domiterator");(function(){function b(g){if(arguments.length<1){return}this.range=g;this.forceBrBreak=0;this.enlargeBr=1;this.enforceRealBlocks=0;this._||(this._={})}var c=/^[\r\n\t ]+$/,f=CKEDITOR.dom.walker.bookmark(false,true),e=CKEDITOR.dom.walker.whitespaces(true),a=function(g){return f(g)&&e(g)};function d(j,g,i){var h=j.getNextSourceNode(g,null,i);while(!f(h)){h=h.getNextSourceNode(g,null,i)}return h}b.prototype={getNextParagraph:function(E){var p;var t;var s;var x;var y,l;if(!this._.lastNode){t=this.range.clone();t.shrink(CKEDITOR.NODE_ELEMENT,true);x=t.endContainer.hasAscendant("pre",true)||t.startContainer.hasAscendant("pre",true);t.enlarge(this.forceBrBreak&&!x||!this.enlargeBr?CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:CKEDITOR.ENLARGE_BLOCK_CONTENTS);var z=new CKEDITOR.dom.walker(t),r=CKEDITOR.dom.walker.bookmark(true,true);z.evaluator=r;this._.nextNode=z.next();z=new CKEDITOR.dom.walker(t);z.evaluator=r;var m=z.previous();this._.lastNode=m.getNextSourceNode(true);if(this._.lastNode&&this._.lastNode.type==CKEDITOR.NODE_TEXT&&!CKEDITOR.tools.trim(this._.lastNode.getText())&&this._.lastNode.getParent().isBlockBoundary()){var n=new CKEDITOR.dom.range(t.document);n.moveToPosition(this._.lastNode,CKEDITOR.POSITION_AFTER_END);if(n.checkEndOfBlock()){var w=new CKEDITOR.dom.elementPath(n.endContainer);var D=w.block||w.blockLimit;this._.lastNode=D.getNextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=this._.docEndMarker=t.document.createText("");this._.lastNode.insertAfter(m)}t=null}var k=this._.nextNode;m=this._.lastNode;this._.nextNode=null;while(k){var i=0,q=k.hasAscendant("pre");var j=(k.type!=CKEDITOR.NODE_ELEMENT),F=0;if(!j){var g=k.getName();if(k.isBlockBoundary(this.forceBrBreak&&!q&&{br:1})){if(g=="br"){j=1}else{if(!t&&!k.getChildCount()&&g!="hr"){p=k;s=k.equals(m);break}}if(t){t.setEndAt(k,CKEDITOR.POSITION_BEFORE_START);if(g!="br"){this._.nextNode=k}}i=1}else{if(k.getFirst()){if(!t){t=new CKEDITOR.dom.range(this.range.document);t.setStartAt(k,CKEDITOR.POSITION_BEFORE_START)}k=k.getFirst();continue}j=1}}else{if(k.type==CKEDITOR.NODE_TEXT){if(c.test(k.getText())){j=0}}}if(j&&!t){t=new CKEDITOR.dom.range(this.range.document);t.setStartAt(k,CKEDITOR.POSITION_BEFORE_START)}s=((!i||j)&&k.equals(m));if(t&&!i){while(!k.getNext(a)&&!s){var o=k.getParent();if(o.isBlockBoundary(this.forceBrBreak&&!q&&{br:1})){i=1;j=0;s=s||(o.equals(m));t.setEndAt(o,CKEDITOR.POSITION_BEFORE_END);break}k=o;j=1;s=(k.equals(m));F=1}}if(j){t.setEndAt(k,CKEDITOR.POSITION_AFTER_END)}k=d(k,F,m);s=!k;if(s||(i&&t)){break}}if(!p){if(!t){this._.docEndMarker&&this._.docEndMarker.remove();this._.nextNode=null;return null}var C=new CKEDITOR.dom.elementPath(t.startContainer);var v=C.blockLimit,h={div:1,th:1,td:1};p=C.block;if(!p&&!this.enforceRealBlocks&&h[v.getName()]&&t.checkStartOfBlock()&&t.checkEndOfBlock()){p=v}else{if(!p||(this.enforceRealBlocks&&p.getName()=="li")){p=this.range.document.createElement(E||"p");t.extractContents().appendTo(p);p.trim();t.insertNode(p);y=l=true}else{if(p.getName()!="li"){if(!t.checkStartOfBlock()||!t.checkEndOfBlock()){p=p.clone(false);t.extractContents().appendTo(p);p.trim();var A=t.splitBlock();y=!A.wasStartOfBlock;l=!A.wasEndOfBlock;t.insertNode(p)}}else{if(!s){this._.nextNode=(p.equals(m)?null:d(t.getBoundaryNodes().endNode,1,m))}}}}}if(y){var u=p.getPrevious();if(u&&u.type==CKEDITOR.NODE_ELEMENT){if(u.getName()=="br"){u.remove()}else{if(u.getLast()&&u.getLast().$.nodeName.toLowerCase()=="br"){u.getLast().remove()}}}}if(l){var B=p.getLast();if(B&&B.type==CKEDITOR.NODE_ELEMENT&&B.getName()=="br"){if(CKEDITOR.env.ie||B.getPrevious(f)||B.getNext(f)){B.remove()}}}if(!this._.nextNode){this._.nextNode=(s||p.equals(m))?null:d(p,1,m)}return p}};CKEDITOR.dom.range.prototype.createIterator=function(){return new b(this)}})();