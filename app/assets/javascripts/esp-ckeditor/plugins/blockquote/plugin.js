(function(){function a(e,g){var f=g.block||g.blockLimit;if(!f||f.getName()=="body"){return CKEDITOR.TRISTATE_OFF}if(f.getAscendant("blockquote",true)){return CKEDITOR.TRISTATE_ON}return CKEDITOR.TRISTATE_OFF}function d(e){var f=e.editor;if(f.readOnly){return}var g=f.getCommand("blockquote");g.state=a(f,e.data.path);g.fire("state")}function c(g){for(var e=0,f=g.getChildCount(),h;e<f&&(h=g.getChild(e));e++){if(h.type==CKEDITOR.NODE_ELEMENT&&h.isBlockBoundary()){return false}}return true}var b={exec:function(k){var m=k.getCommand("blockquote").state,I=k.getSelection(),v=I&&I.getRanges(true)[0];if(!v){return}var n=I.createBookmarks();if(CKEDITOR.env.ie){var h=n[0].startNode,B=n[0].endNode,l;if(h&&h.getParent().getName()=="blockquote"){l=h;while((l=l.getNext())){if(l.type==CKEDITOR.NODE_ELEMENT&&l.isBlockBoundary()){h.move(l,true);break}}}if(B&&B.getParent().getName()=="blockquote"){l=B;while((l=l.getPrevious())){if(l.type==CKEDITOR.NODE_ELEMENT&&l.isBlockBoundary()){B.move(l);break}}}}var y=v.createIterator(),r;y.enlargeBr=k.config.enterMode!=CKEDITOR.ENTER_BR;if(m==CKEDITOR.TRISTATE_OFF){var s=[];while((r=y.getNextParagraph())){s.push(r)}if(s.length<1){var g=k.document.createElement(k.config.enterMode==CKEDITOR.ENTER_P?"p":"div"),j=n.shift();v.insertNode(g);g.append(new CKEDITOR.dom.text("\ufeff",k.document));v.moveToBookmark(j);v.selectNodeContents(g);v.collapse(true);j=v.createBookmark();s.push(g);n.unshift(j)}var t=s[0].getParent(),F=[];for(var C=0;C<s.length;C++){r=s[C];t=t.getCommonAncestor(r.getParent())}var D={table:1,tbody:1,tr:1,ol:1,ul:1};while(D[t.getName()]){t=t.getParent()}var E=null;while(s.length>0){r=s.shift();while(!r.getParent().equals(t)){r=r.getParent()}if(!r.equals(E)){F.push(r)}E=r}while(F.length>0){r=F.shift();if(r.getName()=="blockquote"){var f=new CKEDITOR.dom.documentFragment(k.document);while(r.getFirst()){f.append(r.getFirst().remove());s.push(f.getLast())}f.replace(r)}else{s.push(r)}}var z=k.document.createElement("blockquote");z.insertBefore(s[0]);while(s.length>0){r=s.shift();z.append(r)}}else{if(m==CKEDITOR.TRISTATE_ON){var G=[],u={};while((r=y.getNextParagraph())){var H=null,w=null;while(r.getParent()){if(r.getParent().getName()=="blockquote"){H=r.getParent();w=r;break}r=r.getParent()}if(H&&w&&!w.getCustomData("blockquote_moveout")){G.push(w);CKEDITOR.dom.element.setMarker(u,w,"blockquote_moveout",true)}}CKEDITOR.dom.element.clearAllMarkers(u);var e=[],q=[];u={};while(G.length>0){var A=G.shift();z=A.getParent();if(!A.getPrevious()){A.remove().insertBefore(z)}else{if(!A.getNext()){A.remove().insertAfter(z)}else{A.breakParent(A.getParent());q.push(A.getNext())}}if(!z.getCustomData("blockquote_processed")){q.push(z);CKEDITOR.dom.element.setMarker(u,z,"blockquote_processed",true)}e.push(A)}CKEDITOR.dom.element.clearAllMarkers(u);for(C=q.length-1;C>=0;C--){z=q[C];if(c(z)){z.remove()}}if(k.config.enterMode==CKEDITOR.ENTER_BR){var p=true;while(e.length){A=e.shift();if(A.getName()=="div"){f=new CKEDITOR.dom.documentFragment(k.document);var x=p&&A.getPrevious()&&!(A.getPrevious().type==CKEDITOR.NODE_ELEMENT&&A.getPrevious().isBlockBoundary());if(x){f.append(k.document.createElement("br"))}var o=A.getNext()&&!(A.getNext().type==CKEDITOR.NODE_ELEMENT&&A.getNext().isBlockBoundary());while(A.getFirst()){A.getFirst().remove().appendTo(f)}if(o){f.append(k.document.createElement("br"))}f.replace(A);p=false}}}}}I.selectBookmarks(n);k.focus()}};CKEDITOR.plugins.add("blockquote",{init:function(e){e.addCommand("blockquote",b);e.ui.addButton("Blockquote",{label:e.lang.blockquote,command:"blockquote"});e.on("selectionChange",d)},requires:["domiterator"]})})();