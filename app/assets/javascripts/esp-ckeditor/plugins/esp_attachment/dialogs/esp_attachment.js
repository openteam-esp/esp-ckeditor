(function(){CKEDITOR.dialog.add('esp_attachment',function(j){var k=/^(_(?:self|top|parent|blank))$/;var l=function(a,b){var c=b?b.getAttribute('href'):'',emailMatch,anchorMatch,urlMatch,retval={};retval.type='url';retval.url=c;if(b){var d=b.getAttribute('target');retval.target={};if(d){var e=d.match(k);if(e)retval.target.type=retval.target.name=d;else{retval.target.type='frame';retval.target.name=d}}var f=this;retval.title=b.getAttribute('title')}var g=a.document.getElementsByTag('img'),realAnchors=new CKEDITOR.dom.nodeList(a.document.$.anchors),anchors=retval.anchors=[];for(var i=0;i<g.count();i++){var h=g.getItem(i);if(h.getAttribute('_cke_realelement')&&h.getAttribute('_cke_real_element_type')=='anchor'){anchors.push(a.restoreRealElement(h))}}for(i=0;i<realAnchors.count();i++)anchors.push(realAnchors.getItem(i));for(i=0;i<anchors.length;i++){h=anchors[i];anchors[i]={name:h.getAttribute('name'),id:h.getAttribute('id')}}this._.selectedElement=b;return retval};var m=function(){var a=this.getDialog(),targetName=a.getContentElement('info','linkTargetName'),value=this.getValue();if(!targetName)return;targetName.setLabel(j.lang.link.targetFrameName);this.getDialog().setValueOf('info','linkTargetName',value.charAt(0)=='_'?value:'')};function parseUrl(a){var b=a.split('/').pop();var c=b.split('.').pop();return{filename:b.replace(/%20/g," "),className:"attach_"+c}}return{title:j.lang.esp_attachment.title,minWidth:420,minHeight:200,onShow:function(){this.fakeObj=false;var a=this.getParentEditor(),selection=a.getSelection(),ranges=selection.getRanges(),element=null,me=this;if(ranges.length==1){var b=ranges[0].getCommonAncestor(true);element=b.getAscendant('a',true);if(element&&element.getAttribute('href')){selection.selectElement(element)}else if((element=b.getAscendant('img',true))&&element.getAttribute('_cke_real_element_type')&&element.getAttribute('_cke_real_element_type')=='anchor'){this.fakeObj=element;element=a.restoreRealElement(this.fakeObj);selection.selectElement(this.fakeObj)}else element=null}this.setupContent(l.apply(this,[a,element]))},onOk:function(){var a={href:''},removeAttributes=[],data={href:a.href},me=this,j=this.getParentEditor();this.commitContent(data);var b=data.url||'';a.href=(b.indexOf('/')===0||b.indexOf('http://')===0)?b:"http://"+b;var c=parseUrl(b);var d=data.title||'';a.title=(data.title.length==0)?c.filename:data.title;a.class=c.className;if(data.target){if(data.target.type!='notSet'&&data.target.name)a.target=data.target.name;else removeAttributes.push('target');removeAttributes.push('_cke_pa_onclick','onclick')}if(!this._.selectedElement){var e=j.getSelection(),ranges=e.getRanges();if(ranges.length==1&&ranges[0].collapsed){var f=new CKEDITOR.dom.text(a.title,j.document);ranges[0].insertNode(f);ranges[0].selectNodeContents(f);e.selectRanges(ranges)}var g=new CKEDITOR.style({element:'a',attributes:a});g.type=CKEDITOR.STYLE_INLINE;g.apply(j.document)}else{var h=this._.selectedElement;if(CKEDITOR.env.ie&&a.name!=h.getAttribute('name')){var i=new CKEDITOR.dom.element('<a name="'+CKEDITOR.tools.htmlEncode(a.name)+'">',j.document);e=j.getSelection();h.moveChildren(i);h.copyAttributes(i,{name:1});i.replace(h);h=i;e.selectElement(h)}h.setAttributes(a);h.removeAttributes(removeAttributes);if(h.getAttribute('title'))h.setHtml(h.getAttribute('title'));if(h.getAttribute('name'))h.addClass('cke_anchor');else h.removeClass('cke_anchor');if(this.fakeObj)j.createFakeElement(h,'cke_anchor','anchor').replace(this.fakeObj);delete this._.selectedElement}},contents:[{label:j.lang.common.generalTab,id:'info',accessKey:'I',elements:[{type:'vbox',padding:0,children:[{type:'html',html:'<span>'+CKEDITOR.tools.htmlEncode(j.lang.esp_attachment.url)+'</span>'},{type:'hbox',widths:['320px','80px'],align:'right',children:[{id:'txtUrl',type:'text',label:'',validate:CKEDITOR.dialog.validate.notEmpty(j.lang.flash.validateSrc),setup:function(a){if(a.url)this.setValue(a.url);this.select()},commit:function(a){a.url=this.getValue()}},{type:'button',id:'browse',filebrowser:'info:txtUrl',hidden:true,align:'center',label:j.lang.esp_attachment.browseServer}]}]},{type:'vbox',padding:0,children:[{id:'txtAlt',type:'text',label:j.lang.esp_attachment.name,setup:function(a){if(a.title)this.setValue(a.title)},commit:function(a){a.title=this.getValue()}}]},{type:'hbox',widths:['50%','50%'],children:[{type:'select',id:'linkTargetType',label:j.lang.link.target,'default':'notSet',style:'width : 100%;','items':[[j.lang.esp_attachment.link.targetNotSet,'notSet'],[j.lang.esp_attachment.link.targetFrame,'frame'],[j.lang.esp_attachment.link.targetNew,'_blank'],[j.lang.esp_attachment.link.targetTop,'_top'],[j.lang.esp_attachment.link.targetSelf,'_self'],[j.lang.esp_attachment.link.targetParent,'_parent']],onChange:m,setup:function(a){if(a.target)this.setValue(a.target.type)},commit:function(a){if(!a.target)a.target={};a.target.type=this.getValue()}},{type:'text',id:'linkTargetName',label:j.lang.link.targetFrameName,'default':'',setup:function(a){if(a.target)this.setValue(a.target.name)},commit:function(a){if(!a.target)a.target={};a.target.name=this.getValue()}}]}]}]}})})();