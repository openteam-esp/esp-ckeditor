(function(){CKEDITOR.dialog.add("esp_attachment",function(c){var e=/^(_(?:self|top|parent|blank))$/;var b=function(q,n){var j=n?n.getAttribute("href"):"",p,o,l,k={};k.type="url";k.url=j;if(n){var r=n.getAttribute("target");k.target={};if(r){var h=r.match(e);if(h){k.target.type=k.target.name=r}else{k.target.type="frame";k.target.name=r}}var s=this;k.title=n.getAttribute("title")}var f=q.document.getElementsByTag("img"),t=new CKEDITOR.dom.nodeList(q.document.$.anchors),g=k.anchors=[];for(var m=0;m<f.count();m++){var u=f.getItem(m);if(u.getAttribute("_cke_realelement")&&u.getAttribute("_cke_real_element_type")=="anchor"){g.push(q.restoreRealElement(u))}}for(m=0;m<t.count();m++){g.push(t.getItem(m))}for(m=0;m<g.length;m++){u=g[m];g[m]={name:u.getAttribute("name"),id:u.getAttribute("id")}}this._.selectedElement=n;return k};var d=function(){var f=this.getDialog(),g=f.getContentElement("info","linkTargetName"),h=this.getValue();if(!g){return}g.setLabel(c.lang.link.targetFrameName);this.getDialog().setValueOf("info","linkTargetName",h.charAt(0)=="_"?h:"")};function a(g){var f=g.split("/").pop();var h=f.split(".").pop();return{filename:f.replace(/%20/g," "),className:"attach_"+h}}return{title:c.lang.esp_attachment.title,minWidth:420,minHeight:200,onShow:function(){this.fakeObj=false;var i=this.getParentEditor(),h=i.getSelection(),f=h.getRanges(),g=null,k=this;if(f.length==1){var j=f[0].getCommonAncestor(true);g=j.getAscendant("a",true);if(g&&g.getAttribute("href")){h.selectElement(g)}else{if((g=j.getAscendant("img",true))&&g.getAttribute("_cke_real_element_type")&&g.getAttribute("_cke_real_element_type")=="anchor"){this.fakeObj=g;g=i.restoreRealElement(this.fakeObj);h.selectElement(this.fakeObj)}else{g=null}}}this.setupContent(b.apply(this,[i,g]))},onOk:function(){var j={href:""},p=[],l={href:j.href},o=this,n=this.getParentEditor();this.commitContent(l);var h=l.url||"";j.href=(h.indexOf("/")===0||h.indexOf("http://")===0)?h:"http://"+h;var i=a(h);var q=l.title||"";j.title=(l.title.length==0)?i.filename:l.title;if(l.target){if(l.target.type!="notSet"&&l.target.name){j.target=l.target.name}else{p.push("target")}p.push("_cke_pa_onclick","onclick")}if(!this._.selectedElement){var r=n.getSelection(),g=r.getRanges();if(g.length==1&&g[0].collapsed){var s=new CKEDITOR.dom.text(j.title,n.document);g[0].insertNode(s);g[0].selectNodeContents(s);r.selectRanges(g)}var f=new CKEDITOR.style({element:"a",attributes:j});f.type=CKEDITOR.STYLE_INLINE;f.apply(n.document)}else{var k=this._.selectedElement;if(CKEDITOR.env.ie&&j.name!=k.getAttribute("name")){var m=new CKEDITOR.dom.element('<a name="'+CKEDITOR.tools.htmlEncode(j.name)+'">',n.document);r=n.getSelection();k.moveChildren(m);k.copyAttributes(m,{name:1});m.replace(k);k=m;r.selectElement(k)}k.setAttributes(j);k.removeAttributes(p);if(k.getAttribute("title")){k.setHtml(k.getAttribute("title"))}if(k.getAttribute("name")){k.addClass("cke_anchor")}else{k.removeClass("cke_anchor")}if(this.fakeObj){n.createFakeElement(k,"cke_anchor","anchor").replace(this.fakeObj)}delete this._.selectedElement}},contents:[{label:c.lang.common.generalTab,id:"info",accessKey:"I",elements:[{type:"vbox",padding:0,children:[{type:"html",html:"<span>"+CKEDITOR.tools.htmlEncode(c.lang.esp_attachment.url)+"</span>"},{type:"hbox",widths:["320px","80px"],align:"right",children:[{id:"txtUrl",type:"text",label:"",validate:CKEDITOR.dialog.validate.notEmpty(c.lang.flash.validateSrc),setup:function(f){if(f.url){this.setValue(f.url)}this.select()},commit:function(f){f.url=this.getValue()}},{type:"button",id:"browse",filebrowser:"info:txtUrl",hidden:true,align:"center",label:c.lang.esp_attachment.browseServer}]}]},{type:"vbox",padding:0,children:[{id:"txtAlt",type:"text",label:c.lang.esp_attachment.name,setup:function(f){if(f.title){this.setValue(f.title)}},commit:function(f){f.title=this.getValue()}}]},{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:c.lang.link.target,"default":"notSet",style:"width : 100%;",items:[[c.lang.esp_attachment.link.targetNotSet,"notSet"],[c.lang.esp_attachment.link.targetFrame,"frame"],[c.lang.esp_attachment.link.targetNew,"_blank"],[c.lang.esp_attachment.link.targetTop,"_top"],[c.lang.esp_attachment.link.targetSelf,"_self"],[c.lang.esp_attachment.link.targetParent,"_parent"]],onChange:d,setup:function(f){if(f.target){this.setValue(f.target.type)}},commit:function(f){if(!f.target){f.target={}}f.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:c.lang.link.targetFrameName,"default":"",setup:function(f){if(f.target){this.setValue(f.target.name)}},commit:function(f){if(!f.target){f.target={}}f.target.name=this.getValue()}}]}]}]}})})();